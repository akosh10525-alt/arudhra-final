<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Feedback - AKOSH 1.2</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: url("Images/Login_Background.jpg") no-repeat center fixed;
      background-size: cover;
      font-family: Arial, sans-serif;
    }

    .top-bar {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 80px;
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 40px;
      background: linear-gradient(90deg, #00264d, #004080);
      color: white; z-index: 1000;
      box-shadow: 0px 3px 10px rgba(0,0,0,0.3);
    }

    .logo img { height: 60px; width: auto; }

    .title-box { text-align: center; font-size: 26px; font-weight: bold; flex: 1; }
    .subtitle { font-size: 14px; font-weight: normal; color: #d9e6f2; }

    /* Profile Dropdown */
    .profile-menu { position: relative; display: inline-block; }
    .profile-icon { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; background-color: white; cursor: pointer; }
    .dropdown-content { display: none; position: absolute; right: 0; margin-top: 10px; background-color: white; min-width: 180px; box-shadow: 0px 4px 10px rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; z-index: 2000; }
    .dropdown-content a { color: #003366; padding: 12px 16px; text-decoration: none; display: block; font-weight: bold; }
    .dropdown-content a:hover { background-color: #003366; color: white; }
    .profile-menu:hover .dropdown-content { display: block; }

    .container { margin-top: 120px; width: 95%; max-width: 1400px; margin-left: auto; margin-right: auto; background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; box-shadow: 0px 4px 15px rgba(0,0,0,0.3); text-align: center; overflow-x: auto; }

    .filter-box { text-align: right; margin-bottom: 15px; }
    select { padding: 6px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #003366; color: white; }
    tr:nth-child(even) { background: #f2f2f2; }

    th.feedback-col, td.feedback-col { width: 40%; word-wrap: break-word; white-space: pre-wrap; }

    button { padding: 5px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .resolve-btn { background: #28a745; color: white; }
    .reopen-btn { background: #dc3545; color: white; }

    /* Pagination */
    .pagination { margin-top: 15px; text-align: center; }
    .pagination button { margin: 0 5px; padding: 6px 12px; }
  </style>
</head>
<body>

  <!-- Top Bar -->
  <div class="top-bar">
    <div class="logo"><img src="Images/AFTC_logo.png" alt="Logo"></div>
    <div class="title-box">Manage Feedback <br><span class="subtitle">AKOSH 1.2</span></div>
    <div class="profile-menu">
      <img src="Images/profile_icon.png" alt="Profile" class="profile-icon">
      <div class="dropdown-content">
        <a id="profileName">Profile</a>
        <a href="/logout">Sign Out</a>
      </div>
    </div>
  </div>

  <!-- Feedback Table -->
  <div class="container">
    <h2>All Feedback</h2>
    <div class="filter-box">
      <label for="statusFilter"><b>Filter:</b></label>
      <select id="statusFilter" onchange="renderTable()">
        <option value="All">All</option>
        <option value="Resolved">Resolved</option>
        <option value="Unresolved">Unresolved</option>
      </select>
    </div>

    <table id="feedbackTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Rank</th>
          <th>Authority</th>
          <th class="feedback-col">Feedback</th>
          <th>Date & Time</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="7">Loading...</td></tr></tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination" id="pagination"></div>
  </div>

  <script>
    let allFeedback = [];
    let currentPage = 1;
    const rowsPerPage = 10;

    // Fetch user info
    fetch("/api/user")
      .then(r => r.json())
      .then(data => {
        if (data.status !== "success") { window.location.href = "/"; return; }
        const user = data.user;
        document.getElementById("profileName").innerText = `${user.rank || ""} ${user.name || ""}`;
        if (user.authority === 2) {
          alert("Access denied. Only admins can view feedback.");
          window.location.href = "/dashboard";
        }
      });

    // Fetch feedback data
    fetch("/api/manage_feedback")
      .then(r => r.json())
      .then(data => {
        if (data.status === "success") {
          allFeedback = data.feedback;
          renderTable();
        }
      });

    function renderTable() {
      const filter = document.getElementById("statusFilter").value;
      const tbody = document.querySelector("#feedbackTable tbody");
      tbody.innerHTML = "";

      let filtered = allFeedback;
      if (filter !== "All") {
        filtered = allFeedback.filter(fb => (fb.status || "Unresolved") === filter);
      }

      const totalPages = Math.ceil(filtered.length / rowsPerPage);
      if (currentPage > totalPages) currentPage = totalPages || 1;
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filtered.slice(start, end);

      if (pageData.length === 0) {
        tbody.innerHTML = "<tr><td colspan='7'>No feedback available</td></tr>";
      } else {
        pageData.forEach((fb, idx) => {
          const row = document.createElement("tr");
          let actionBtn = fb.status === "Resolved"
            ? `<button class="reopen-btn" onclick="updateFeedback(${start+idx}, 'Unresolved')">Reopen</button>`
            : `<button class="resolve-btn" onclick="updateFeedback(${start+idx}, 'Resolved')">Mark Resolved</button>`;

          row.innerHTML = `
            <td>${fb.name}</td>
            <td>${fb.rank}</td>
            <td>${fb.authority}</td>
            <td class="feedback-col">${fb.feedback}</td>
            <td>${fb.datetime}</td>
            <td>${fb.status || "Unresolved"}</td>
            <td>${actionBtn}</td>
          `;
          tbody.appendChild(row);
        });
      }

      renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      if (totalPages <= 1) return;

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        if (i === currentPage) {
          btn.style.fontWeight = "bold";
          btn.style.background = "#003366";
          btn.style.color = "white";
        }
        btn.addEventListener("click", () => {
          currentPage = i;
          renderTable();
        });
        pagination.appendChild(btn);
      }
    }

    function updateFeedback(index, status) {
      fetch("/api/update_feedback", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({index: index, status: status})
      })
      .then(r => r.json())
      .then(data => {
        alert(data.message);
        location.reload();
      });
    }
  </script>
</body>
</html>
